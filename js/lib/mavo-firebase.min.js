'use strict';(function(){var a=Number.isInteger,b=window.Bliss,c=window.Mavo,d=window.firebase;c.Backend.register(b.Class({extends:c.Backend,id:'Firebase',constructor:function constructor(a){var c=this,e=this.mavo.id||'mavo',f={},g=/^https:\/\/.*\.firebaseio\.com$/.test(a);function b(a){if(a)return a.split(/\s+/);return''===a?[]:void 0}if(g){if(f={apiKey:this.mavo.element.getAttribute('mv-firebase-api-key'),authDomain:this.mavo.element.getAttribute('mv-firebase-auth-domain'),databaseURL:a,storageBucket:this.mavo.element.getAttribute('mv-firebase-storage-bucket')},!f.apiKey)return this.mavo.error('Firebase: mv-firebase-api-key attribute missing');this.app=d.apps.length?d.initializeApp(f,'app'+d.apps.length):d.initializeApp(f)}else{if(f=d.default.app().options,!f.apiKey)return this.mavo.error('Firebase: apiKey missing from config');this.app=d.default}this.statusChangesCallbacks=[];var h=this.mavo.element.getAttribute('mv-unauthenticated-permissions'),i=this.mavo.element.getAttribute('mv-authenticated-permissions'),j=b(i)||['read','edit','add','delete','save','logout'],k=b(h);if(!k)k=f.authDomain?['read','login']:['read'];else if(!f.authDomain&&k.includes('login'))return g?this.mavo.error('Firebase: authDomain missing from config (needed if permission \'login\' is specified)'):this.mavo.error('Firebase: firebase-auth-domain attribute missing (needed if permission \'login\' is specified)');this.defaultPermissions={authenticated:j,unauthenticated:k},this.permissions.on(this.defaultPermissions.unauthenticated),this.db=this.app.database().ref(e),f.storageBucket&&(this.storage=this.app.storage().ref(e),this.upload=function(a){var b=this.storage.child(a.name+'-'+Date.now());return b.put(a).then(function(){return b.getDownloadURL()})}),this.app.auth().onAuthStateChanged(function(a){a&&(c.permissions.off(c.defaultPermissions.unauthenticated).on(c.defaultPermissions.authenticated),c.user={username:a.email,name:a.displayName,avatar:a.photoURL})},function(a){c.mavo.error('Firebase: '+a.message)});var l=this.mavo.element.getAttribute('mv-server-push');null!==l&&'false'!==l&&this.setListenForChanges(!0)},onStatusChange:function onStatusChange(a){var b=this;this.statusChangesCallbacks.push(a);this.listeningOnStatus||(this.listeningOnStatus=!0,this.app.database().ref('.info/connected').on('value',function(a){b.statusChangesCallbacks.forEach(function(b){return b(a.val())})}))},setListenForChanges:function setListenForChanges(a){var b=this;a?!this.listeningForChanges&&this.db.on('value',function(a){var c=a.val();1!==b.compareDocRevs({_rev:b.rev},c)||(b.rev=c._rev,b.onNewData(c))}):this.db.off(),this.listeningForChanges=a},onNewData:function onNewData(a){return this.mavo.render(a)},load:function load(){var a=this;return this.db.once('value').then(function(b){var c=b.val();return c?(a.rev=c._rev||1,c):(a.rev=1,{})})},store:function store(a){var b=this;return Promise.resolve().then(function(){if(b.storeData=a,b.mavo.unsavedChanges&&!b.storing)return b.storing=!0,b.put().then(function(){b.storing=!1})})},put:function put(b){var c=this;return b=this.storeData||b,delete this.storeData,this.db.transaction(function(d){return c.rev=d?a(d._rev)?d._rev+1:1:1,Object.assign(b,{_rev:c.rev})}).then(function(){if(c.storeData)return c.put()})},login:function login(){var a=this;return this.ready.then(function(){if(!a.user){var b=new d.auth.GoogleAuthProvider;return a.app.auth().signInWithPopup(b).catch(function(b){return a.mavo.error('Firebase: '+b.message),Promise.reject(b)})}})},logout:function logout(){var a=this;return this.app.auth().signOut().then(function(){a.permissions.off(a.defaultPermissions.authenticated).on(a.defaultPermissions.unauthenticated)}).catch(function(b){a.mavo.error('Firebase: '+b.message)})},compareDocRevs:function compareDocRevs(b,c){return b&&a(b._rev)?c&&a(c._rev)?b._rev===c._rev?0:b._rev<c._rev?1:-1:-1:1},static:{test:function test(a){return /^(firebase|https:\/\/.*\.firebaseio\.com)$/.test(a)}}}))})();

//# sourceMappingURL=mavo-firebase.min.js.map